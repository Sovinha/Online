{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">ðŸ“Š Dashboard Financeiro</h3>
    
    <form class="row g-2 d-print-none" method="GET">
        <div class="col-auto">
            <input type="date" name="data_inicio" class="form-control form-control-sm" title="Data Inicial" value="{{ request.args.get('data_inicio', '') }}">
        </div>
        <div class="col-auto">
            <input type="date" name="data_fim" class="form-control form-control-sm" title="Data Final" value="{{ request.args.get('data_fim', '') }}">
        </div>
        
        <div class="col-auto">
            <select name="loja" class="form-select form-select-sm">
                <option value="">Todas as Lojas</option>
                {% for loja in todas_lojas %}
                <option value="{{ loja }}" {% if request.args.get('loja') == loja %}selected{% endif %}>{{ loja }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-auto">
            <select name="turno" class="form-select form-select-sm">
                <option value="">Todos os Turnos</option>
                <option value="AlmoÃ§o" {% if request.args.get('turno') == 'AlmoÃ§o' %}selected{% endif %}>AlmoÃ§o</option>
                <option value="Jantar" {% if request.args.get('turno') == 'Jantar' %}selected{% endif %}>Jantar</option>
            </select>
        </div>

        <div class="col-auto">
            <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary btn-sm">Limpar</a>
        </div>
    </form>
</div>

<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card shadow-sm border-0 bg-dark text-white">
            <div class="card-body">
                <h6 class="text-secondary small fw-bold">FATURAMENTO TOTAL</h6>
                <h3 class="mb-0">R$ {{ "%.2f"|format(fin_geral.faturamento) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0 bg-primary text-white">
            <div class="card-body">
                <h6 class="text-white-50 small fw-bold">TAXAS (CLIENTES)</h6>
                <h3 class="mb-0">R$ {{ "%.2f"|format(fin_geral.taxas_clientes) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0 bg-danger text-white">
            <div class="card-body">
                <h6 class="text-white-50 small fw-bold">PAGO MOTOBOYS</h6>
                <h3 class="mb-0">R$ {{ "%.2f"|format(total_geral) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        {% set cobertura = (fin_geral.taxas_clientes / total_geral * 100) if total_geral > 0 else 0 %}
        <div class="card shadow-sm border-0 {% if cobertura < 85 %}bg-warning{% else %}bg-success{% endif %} text-white">
            <div class="card-body">
                <h6 class="text-white-50 small fw-bold">COBERTURA DE FRETE</h6>
                <h3 class="mb-0">{{ "%.2f"|format(cobertura) }}%</h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="fw-bold text-muted mb-3">Custos por Unidade</h6>
                <canvas id="graficoLoja"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="fw-bold text-muted mb-3">EficiÃªncia: Recebido vs Pago</h6>
                <canvas id="graficoEficiencia"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // Passagem de dados do Jinja para o JavaScript
    const dadosLoja = {
        labels: {{ por_loja | map(attribute=0) | list | tojson }},
        values: {{ por_loja | map(attribute=1) | list | tojson }}
    };

    const dadosFin = {
        pago: {{ total_geral | tojson }},
        recebido: {{ fin_geral.taxas_clientes | tojson }}
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/dashboard.js"></script>

{% endblock %}